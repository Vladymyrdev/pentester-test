import React, { useEffect, useState } from "react";
import axios from "axios";
import { Row, Col, Form, Button } from "react-bootstrap";

import AnnotatedDocumentViewer from "./AnnotatedDocumentViewer";

interface annotatedText {
  text: string;
  mentions: {
    begin_offset: number;
    content: string;
    end_offset: number;
    type: string;
    metadata: {
      iso_date: string;
    };
  }[];
}

const DocumentAnnotator = (): JSX.Element => {
  const defaultTextPlaceholder =
    "Alan Turing was born on 23/06/1912. During the Second World War, he worked as a scientist for the Government Code and Cypher School (currently GCHQ) at Bletchley Park, Britain's codebreaking centre that produced Ultra intelligence.";
  const emptyDocument = {
    text: "",
    mentions: [],
  };
  const [inputValue, setInputValue] = useState(defaultTextPlaceholder);
  const [annotatedDoc, setAnnotatedDoc] =
    useState<annotatedText>(emptyDocument);

  const analyzeInput = () => {
    axios
      .post(`${process.env.REACT_APP_NATURAL_LANG_API_HOST}/api/annotate/`, {
        text: inputValue,
      })
      .then((res) => {
        setAnnotatedDoc(res.data);
      })
      .catch((err) => console.log(err));
  };

  const preparedText = annotatedDoc.mentions.reduce((acc, { content }) => {
    return acc.replace(
      new RegExp(content, "g"),
      `<span class="show-up-text">${content}</span>`
    );
  }, annotatedDoc.text);

  return (
    <Row>
      <Col>
        <Form>
          <Form.Group controlId="formInputText">
            <Form.Control
              as="textarea"
              rows={5}
              value={inputValue}
              onChange={(e) => setInputValue(e.target.value)}
            />
          </Form.Group>
          <Button
            variant="primary"
            onClick={analyzeInput}
            style={{ float: "right" }}
          >
            Analyze
          </Button>
        </Form>
      </Col>
      <Col>
        <AnnotatedDocumentViewer document={annotatedDoc} text={preparedText} />
      </Col>
    </Row>
  );
};

export default DocumentAnnotator;
